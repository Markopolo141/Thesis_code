\chapter{The GNK value: A new solution}
\label{cha:new_solution}

In the last chapter we introduced several different mathematical approaches to the problem of allocation and in this chapter we introduce a new solution that builds upon some elements of the previous solutions.

Particularly we develop a solution concept that extends Nash bargaining with endogenous disagreement point (from section \ref{sec:solutions_bargaining}) to a solution concept accommodating arbitrary numbers of players.
Our solution extends the work of others to the space of generalised non-cooperative games, which are then suitable for describing various electrical network contexts.

We call our new solution concept the \textit{Generalized Neyman and Kohlberg Value} or \textit{GNK value} for short, and is computed and compared against other solutions concepts of the previous chapter in the context of electricity allocation.
By this comparison it is seen that the different solution concepts give different outcomes, and we discuss these differences in light of our ethical considerations (from Chapter \ref{cha:background}).

The material from this chapter extends from work which was originally submitted to AAMAS, and was accepted as an extended abstract: \\
\-\hspace{5mm}``The Generalized N\&K Value: An Axiomatic Mechanism for Electricity Trading''\\ International Conference on Autonomous Agents and Multiagent Systems\\ (AAMAS) 2018 (accessible: \href{ifaamas.org/Proceedings/aamas2018/pdfs/p1883.pdf}{ifaamas.org/Proceedings/aamas2018/pdfs/p1883.pdf})


\section{Prelude to the GNK value}

In the previous chapter we introduced several different solution concepts, each stemming from different ethical principles and perspectives.

In this section we detail a new approach that combines some of the features of the solution concepts outlaid in the previous chapter.
The primary motivation for this new solution, is to attempt to distil the intuition behind the Nash bargaining solution concepts (per section \ref{sec:solutions_bargaining}) into a description of total allocation that is suitable for arbitrary number of players - rather than just two.



In the Nash bargaining solution concept, the minimax payoff advantage between two parties is considered as a measure of bargaining strength between them, and so in our new solution we consider the minimax payoff advantages that could occur in bargaining between all possible coalitions of players.
Our new solution then allocates power and utility to players directly in proportion to these bargaining strengths using Shapley Value axioms.
In this way our new solution allocates utility in proportion to the leverage that all the individuals - and groups of individuals - could hypothetically posses in bargaining for outcomes they desire.

Our approach straightforwardly relates to many of the concepts of the previous section: where we have a fundamentally coalitional scheme (per Coalitional Game Theory), that rewards based upon disagreement points (Bargaining Theory), which is partially informed by how much individual's participation influences the group's wellbeing (reminiscent of VCG), and attempts to describe normative trading between large numbers of participants (Marginalism).

%much more than they are necessarily prescriptive outcomes of an idealised ethics.
%Though the two (ideal competitive outcomes and ethical outcomes) may be related, or even identical in certain contexts - such as where no particular ethical principles apply or the purpose of the engagement is the competition (such as in sports).
%And it is in this same way that the Marginalism outlined in Section \ref{} is often primarily treated usually begin descriptive than prescriptive.

%However there is a line of ethical thinking that idealises competition as being associated-with or determining appropriate ethics; as we consider in Section \ref{}, and for those inclined to think that way then our solution is all the more relevant.
%In anycase, the process of crafting better (or different) descriptions of competitive outcomes is not to be feared, as it may be usefull for describing situations as they might occur under free competition, or as a starting point for implementation in arenas without or prior-to relevant ethical concerns.

Let us begin.

\section{Introduction to the GNK value}

How should we model ideal competition? In the two player case, existing bargaining solutions (such as Nash's) seem rather difficult to surpass as they describe a singular and axiomatic outcome that is both cooperatively pareto-optimal and also accounts for anti-cooperative strategising.

In the context of Nash bargaining with endogenous disagreement point (per section \ref{subsec:nash_bargaining_endogenous}), the disagreement point was interpreted as a unique point defined by a minimax equilibrium in the payoff-advantage of strategies.
However there exists a problem extending this scheme directly to three or more players, as there may not exist a unique minimax equilibrium in payoff-advantages for strategies in a game of three-or-more players.
The question then is how to logically and consistently extend Nash's bargaining solution with endogenous disagreement point to an arbitrary number of players.

While it may be possible to arbitrarily choose one of those possible minimax equilibria in a 3+ person game as the disagreement point, 
instead we consider all the possible divisions of players between two groups and then consider all the two-player minimax payoff advantages between them. We then integrate this information via Shapley Value axioms to form a unique outcome, that does not depend on any arbitrary choice.
In the following sections of this chapter (sections \ref{the_value_def2} to \ref{more_involved}) we give all the details of this process.% Particularly we note that this process of how to reasonably extend Nash's bargaining solution to multiple players has a history.

The fundamental idea behind our approach was first detailed by \cite{values3}.
So far as we know, Harsanyi's solution concepts have never been applied to electricity networks, as there exists a particular problem in doing so, particularly that Harsanyi's solution concepts apply to non-cooperative games but cannot apply to generalised non-cooperative games.
The details of this problem and our novel remedy are given in following sections.

But briefly, in electricity network contexts the mutual interactions of participants can be limited.
And these limitations on the space of possible mutual actions is best modelled by a generalised non-cooperative game, and unfortunately in the context of such a generalised game there is no unique minimax point between two players.
Our principle and novel development in this chapter is the provision of a remedy, such that Harsanyi's solution can then be applied.

The remedy is to take the expected outcome on a coin-flip on who chooses actions first in the minimax strategies - and as we shall see - this turns out to be a unique value that satisfies all required properties, and thus leads to a coherent outcome.

The resulting outcome we call the \textit{Generalized Neyman and Kohlberg Value} or the \textit{GNK value} for short, 
as Harsanyi's solution was also axiomatically derived by \cite{value2,KOHLBERG2018139}.
This solution concept is shown to apply for all transferable utility (TU) generalised non-cooperative games.
The GNK value is thus flexible enough to extend to many contexts, but we focus particularly on the specific case of allocating monetary payments over Optimal Power Flow (OPF) instances under the DC approximation - as we will explain.

Let us derive the GNK value before giving details of its application.

\section{Deriving the GNK value}\label{the_value_def2}

We begin by presenting the axiomatic foundations of the GNK value, in a similar manner as \cite{value2}'s exposition.
We begin by defining the GNK value to be the integration of \emph{threat} values between possible coalitions; defined via Shapley Value axioms.
We then describe the \emph{threat} or \emph{advantage} of a coalition $v(S)$ in the context of a \textit{generalized non-cooperative game} (which is our key point of novelty in the solution concept).
And then we clarify how the GNK value relates to other prominent solution concepts in non-cooperative games.

\subsection{Axiomatic foundations and the \textit{Value}}\label{the_value_def}

%There have been many attempts to answer the question of what cooperative outcome \textit{should} occur in the context of a non-cooperative TU game.
%One well known answer is the \textit{Nash bargaining solution} between two players \cite{nash2}, which Harsanyi extended to arbitrary numbers of players.
%Building on this, Harsanyi's solution \cite{values3} was derived from a simple set of axioms by Neyman and Kohlberg ~\cite{value2}; 
%our axiomatic derivation of a value for games with generalized action spaces mirrors the steps in theirs.

We begin by considering \cite{KOHLBERG2018139}'s \textit{coalitional game of threats}, 
which is a coalitional game defined by a pair $\langle N,v \rangle$ in which:
\begin{itemize}
\item	$N=\{1,\dots,n\}$ is a finite set of \textit{players} or \textit{agents}, and
\item	$v:2^N\rightarrow \mathbb{R}$ is a \textit{characteristic function} with 
\begin{equation}
v(S)=-v(N\setminus S) \label{myeq2} \quad \forall S\subseteq N.
\end{equation}
\end{itemize}
The intuition for \eqref{myeq2} is that the characteristic function of this game is a measure of the strength of the bargaining position (the `threat' or `advantage') that a coalition, $S$, has over its complement, $N\setminus S$.
This contrasts with classical cooperative game theory games, where the characteristic function $v(\emptyset)=0$ and equation \ref{myeq2} does not generally hold (see section \ref{sec:cooperative_game_theory_part}).

Neyman and Kohlberg's key result was to prove that if $\mathbb{D}$ is the set of all such games, then there exists a unique mapping $\varphi:\mathbb{D}\rightarrow\mathbb{R}^n$ that satisfies the following four axioms:

\begin{itemize}
\item	\textbf{Efficiency}: $\sum_i\varphi(\langle N,v\rangle)_i = v(N)\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad~~\refstepcounter{equation}(\theequation)\label{myeq}$
\item	\textbf{Symmetry}: If two players $i$ and $j$ are substitutes, such that if\\ $v(S\cup i)=v(S\cup j)~~\forall S\subseteq N\setminus\{i,j\}$, then $\varphi(\langle N,v\rangle)_i = \varphi(\langle N,v\rangle)_j$
\item	\textbf{Null Player}: If a player $i$ is a null player (i.e.\ $v(S\cup i)=v(S)~~\forall S\subseteq N$) then $\varphi(\langle N,v\rangle)_i=0$
\item	\textbf{Additivity}: for any $v_1$ and $v_2$, $\varphi(\langle N,v_1+v_2\rangle)=\varphi(\langle N,v_1 \rangle) + \varphi(\langle N,v_2\rangle)$
\end{itemize}

Letting agent $i$'s element of $\varphi$ be denoted by $\varphi_i$, this mapping is:
\begin{equation}\label{da_value_eq} 
\varphi_i(\langle N,v\rangle)
= \frac{1}{n}\sum_{k=1}^n v_{i,k} 
= \frac{1}{n}\sum_{k=1}^n \frac{1}{\binom{n-1}{k-1}} \sum_{\substack{S:i\in S \\ |S|=k}}v(S) 
\end{equation}
Where $v_{i,k}$ is the average value of $v(S)$ for all coalitions of size $k$ that include $i$.
This mapping gives a distribution of the total surplus $v(N)$ among the players, and \cite{KOHLBERG2018139} appropriately call this unique mapping the `Shapley Value' of the game of threats as it mirrors the classic \textit{Shapley Value} of cooperative game theory.

Indeed \cite{KOHLBERG2018139} have shown that for any game of threats $\langle N,v\rangle$ there is a classic cooperative game $\langle N,v'\rangle$ where the two Shapley Values are the same.
It is possible to map a game of threats $v$ to a cooperative game $v'$ via relation:
\begin{equation}\label{convert1}
v'(S)=\frac{1}{2}v(S)+\frac{1}{2}v(N)
\end{equation}
%Where the Shapley value is hence given by the classic expression:
%\begin{equation}\label{eq:shapley_value}
%    \varphi_i(\langle N,v\rangle)= \frac{1}{n}\sum_{S\subseteq N\setminus\{i\}} \binom{n-1}{|S|}^{-1} \left(v'(S\cup\{i\})-v'(S)\right) 
%\end{equation}
%Which identifies the Shapley value of a player in a cooperative game as its average over marginal contributions; which we can similarly be expressed by averages over marginal contributions by player and size:
%\begin{equation}\label{eq:shapley_value2}
%\hat{v}_{i,k} = \frac{1}{\binom{n-1}{k}}\sum_{S\subset N\setminus \{ i\} , |S|=k} %\frac{(n-|S|-1)!\,|S|!}{(n-1)!}
%(v'(S\cup\{i\})-v'(S))
%\end{equation}
%\begin{equation}\label{shap2} \varphi_i(\langle N,v\rangle) = \frac{1}{n}\sum_{k=0}^{n-1}\hat{v}_{i,k} \end{equation}
%These multiple formulations of the Shapley value will be useful to us in Section \ref{} where we use these expressions in different methods of sampling the GNK value.


\subsection{Threats in games with general action spaces}\label{the_value_def3}

In this subsection we define the characteristic function $v(S)$, in the context of a \textit{generalized non-cooperative game}.
A generalised non-cooperative game is a game where the strategies available to one player may be restricted by the strategy choice of others.
Such games were introduced by \cite{Debreu01101952} and the problem of finding equilibria in such games has been a topic of further research \citep{Facchinei2007,fischer2014}.

In more detail, a generalised non-cooperative game consists of a triplet $G = \langle N,A,u \rangle$ in which:
\begin{itemize}
\item	$N=\{1,\dots,n\}$ is a finite set of players,
\item	$A\subseteq \prod_{i\in N}A^i$ is a set of all possible joint strategies, where $A^i$ denotes the set of strategies available to player $i\in N$, and $A$ is a subset of their product space
\item	$\{u_i(a) : A\rightarrow \mathbb{R}\}_{i\in N}$ is a set of functions of each player's payoff/utility when joint strategy $a\in A$ is executed.
\end{itemize}

In this context, we wish to describe the payoff `threat' or `advantage' $v(S)$ of a coalition $S\subseteq N$ (letting $A^S=\prod_{i\in S}A^i$), taking into account the constraints that apply to the joint action space.  
A key contribution in our research is the following construction of the coalitional game of threat's characteristic function. 
Denoting $(x,y)\in A$ as a partition of a joint action between two coalitions $S$ and $N\setminus S$, 
the characteristic function for the game of threats with generalised action spaces is given by:
\begin{align}
\label{knvalue1}
v(S) = &
\frac{1}{2}\min_{\substack{y\in A^{N\setminus S} \\ \text{s.t.}\exists x,(x,y)\in A}} 
\max_{\substack{x\in A^S \\ \text{s.t.}(x,y)\in A}}
	\left(\sum_{i\in S} u_i(x,y) - \sum_{i\in N\setminus S}u_i(x,y)\right)\nonumber\\
+&
\frac{1}{2}\max_{\substack{x\in A^S \\ \text{s.t.}\exists y,(x,y)\in A}}
\min_{\substack{y\in A^{N\setminus S} \\ \text{s.t.}(x,y)\in A}}
	\left(\sum_{i\in S} u_i(x,y) - \sum_{i\in N\setminus S} u_i(x,y) \right)
\end{align}

The requisite condition $v(S)=-v(N\setminus S)$, as given in~\eqref{myeq2}, is immediately satisfied irrespective of the structure of strategy space $A$, insofar as the $\max$ and $\min$ terms are defined.
Thus, \eqref{knvalue1} is a feasible representation of the competitive advantage (or threat) that a coalition has over its complement in a generalised strategy space.
With the characteristic function \eqref{knvalue1}, the formulation of $\varphi$ (per \eqref{da_value_eq}) defines the GNK value.
This is a novel extension of existing work to the space of generalised games (see Section~\ref{relating_to_the_old}).

\subsection{Understanding the GNK value}\label{the_value_def4}

In the characteristic function~\eqref{knvalue1}, the inner term:
\[
\sum_{i\in S} u_i(x,y) - \sum_{i\in N\setminus S} u_i(x,y)
\] 
is the sum of payoffs that the coalition $S$ receives, 
minus the sum of payoffs that the complement $N\setminus S$ receives, 
under the joint strategy $(x,y)\in A$, we call this the \textit{payoff advantage} to $S$.

The first line of $v(S)$ in~\eqref{knvalue1} is half the payoff advantage achieved if, the players in $S$ collectively choose their strategies to maximise the payoff advantage knowing that the players in $N\setminus S$ will subsequently choose their strategies to minimise it - and thus this dynamic constitutes a bilevel optimisation problem.
Then the second line of~\eqref{knvalue1} is an additional half of the payoff advantage achieved if the ordering of choice were reversed, with $N\setminus S$ choosing first.
In this way, \eqref{knvalue1} can be interpreted as the expectation of Nash equilibrium payoff advantage of $S$ over its complement under a fair coin-toss of who chooses their strategies first.

In this formulation $v(N) = \max_{a\in A} (\sum_{i\in N} u_i(a))$ is the maximum achievable sum of payoffs that the players can achieve, and the GNK value $\varphi$, splits all of this amount between the players (by the efficiency axiom).
The allocation of utility that the GNK value allocates can be realised by having the players execute the strategies that achieve this maximal sum, and then enacting appropriate utility transfers between the players.
In this way the GNK value can be seen as a method of allocating a Pareto optimal outcome and budget-balanced payments between players, to attain utility proportional to their competitive advantages.

\subsection{Relation to other solution concepts}\label{relating_to_the_old}

The GNK value is closely related to several other solution concepts, and even equivalent to them under certain conditions.

Most immediately, the GNK value is identical to \cite{value2}'s Value when the strategy space $A$ represents a mixed strategy game that is not generalised; that is when the strategy space, $A$, is an unconstrained combination of strategies for all agents (ie. $A = \prod_{i\in N}A^i$).
To see this, we observe that the two halves of \eqref{knvalue1} are equal in the absence of joint action constraints (%proof in Appendix \ref{appendix1}, or 
via direct application of von Neumann's minimax theorem\footnote{see Lemma 1 of \cite{value2}}), 
and hence the characteristic value reduces to that used in Neyman and Kohlberg's original definition:
\begin{equation}\label{knvalue2}v_o(S) = \max_{x\in A^S}\min_{y\in A^{N\setminus S}} \left(\sum_{i\in S} u_i(x,y) - \sum_{i\in N\setminus S} u_i(x,y) \right).\end{equation}
%
That is, Neyman and Kohlberg's Value is the formulation of $\varphi$ (per \eqref{da_value_eq}) 
with $v_o(S)$ (per \eqref{knvalue2}).
Unfortunately Neyman and Kohlberg's Value cannot be directly applied to generalised games because the required condition $v_o(S)=-v_o(N\setminus S)$ can fail to hold in that case. 

Neyman and Kohlberg's Value (and the GNK value) are also directly conceptually related to \cite{values3}'s solution in this context,
while in the 2-player context, it is identical to \cite{kalai1,Kalai2010}'s \textit{coco-value} in the context of complete information  
and also identical to \cite{nash2}'s bargaining solution in the context of transferable utility (see \cite{value2}, or section \ref{subsec:nash_bargaining_endogenous}).
It also shares a conceptual similarity with \cite{aumann1961core}'s $\alpha$ and $\beta$ core solution concepts, and \cite{1944}'s historic formulation :
\begin{equation}\label{knvalue3}v_m(S) = \max_{x\in A^S}\min_{y\in A^{N\setminus S}} \sum_{i\in S} u_i(x,y).\end{equation}


\section{GNK value applied to DC powerflows}\label{more_involved}

Because of its flexibility the GNK value has the potential to be used in a large range of different contexts,
however in this section we focus solely on the development of a simple case --- the pricing the immeditate consumption and generation of power on a meshed network under DC approximation, where all participants have linear utilities over their own power.
Although this construction simplifies away some key technical problems in power networks, it allows us to clarify the analysis of the GNK value and its features.

In this section, we consider an example electricity network under DC approximation and show how the electrical consumption/generation of network participants can be modelled as a generalised game. And then give some details of a computational methods which can be used to compute the GNK value in this context.

\subsection{Network model}\label{sec:the_setup}


We begin by setting out the elements of an electricity network under DC approximation:
\begin{itemize}
    \item A set of buses $B$ with, for all $i\in B$:
    \begin{itemize} 
        \item Power consumption at each bus $p_i$, and 
        \item A bus voltage phase-angle $\theta_i$,
    \end{itemize}
    \item Lines $C\subseteq B\times B$, with, for all $(i,j)\in C$: 
        \begin{itemize} 
        \item Line susceptance $b_{i,j}$, and 
        \item Power flow $p_{i,j}$ (power from bus $i$ to $j$), with $p_{i,j}=-p_{j,i}$. 
    \end{itemize}
\end{itemize}
In this context, the DC approximated powerflow constraints (per \cite{Wang1}) are expressed as follows:
\begin{equation}
\label{dcopf1}
\begin{aligned}
\text{DC-powerflow} \quad& \\
\text{Variables:} \quad&  p_{i\in B},\ \theta_{i\in B},\ p_{(i,j)\in C} \\
\text{constraints:} \quad& p_i^{l}\le p_i \le p_i^{u} \\
&p_{i,j}^l \le p_{i,j} \le p_{i,j}^u \\
&p_j = \sum_{(i,j)\in C}p_{i,j}\\
&p_{i,j} = -b_{i,j}(\theta_i - \theta_j)
\end{aligned}
\end{equation}
where $p_i^{l}$, $p_i^{u}$, $p_{i,j}^l$, $p_{i,j}^u$ are the upper and lower bounds on power consumption/generation and line limits, respectively.

We can eliminate redundant variables, such as $\theta_i$ and $p_{i,j}$, and to ease presentation, and use the abstract functions $h_j$ and $g_k$ (for indices $j,k$) to represent the remaining linear functions:

\begin{equation}
\label{dcopf2}
\begin{aligned}
\text{DC-powerflow}\\
\text{Variables:}\quad & p_{i\in B} \\
\text{constraints:}\quad & h_j(p_1,p_2,\dots)=0\quad \forall j\\
& g_k(p_1,p_2,\dots)\le 0 \quad \forall k
\end{aligned}
\end{equation}

In this DC powerflow network the participants on each bus are treated as players in a game.
For simplicity, we have one player per bus (i.e.~$N=B$), and the power consumption of that bus is the respective player's strategy space (i.e.\ $A_i=[p_i^l,p_i^u]$).
Then the DC constraints define the space of jointly executable strategies --- forming the generalised strategy space $A$.

We further assume that there is a linear utility (or payoff) associated with the power consumption of each player, denoted $u_i(p_i)$ for player $i$, which is all the components of a generalised game.
In the next subsection \ref{sec:example_network} we give a simple example of such a game.



\subsection{An example problem}\label{sec:example_network}

As an example instance, we consider the toy 5-bus network shown in Figure \ref{fig:example1}, with parameters given in Table~\ref{tab:example1}.
From this example it is possible to calculate and subsequently consider the features of the GNK value against LMP and VCG.

To this end, in sections \ref{subsec:LMP_compute1}, \ref{subsec:VCG_compute1} and \ref{subsec:gnk_compute1} we outlay procedures used to calculate the financial payments and dispatched powers under the GNK value, LMP and VCG respectively, against parameter $p_1^l$ (the generator capacity in the network).
As a result of this calculation the financial payments are plotted against $p_1^l$ in Figures \ref{fig:1d}, \ref{fig:1f} and \ref{fig:1h} respectively. Which in addition to the utilities derived from power consumption/generation (Figure \ref{fig:1b}) form the post payment utility imputations as Figures \ref{fig:1c}, \ref{fig:1e} and \ref{fig:1g} respectively.
Subsequently, the features of all these plots are discussed in Section \ref{sec:features}.

We begin by describing the process of calculating the LMP values for this example network before considering VCG and then GNK calculation methodologies; in the order of complexity.

\input{figs/Electro_table.tex}



\subsection{Computing the LMP transfers}\label{subsec:LMP_compute1}

To compute the Locational Marginal Price (LMP) transfers for our example network, we follow a process described in various literature - such as by \cite{lmp1,lmp2}.
Particularly we set up an optimisation problem of maximising the sum of utility subject to the power-flow constraints and then the Locational Marginal Prices are then identified as the Lagrange multipliers associated with the power conservation constraints on each bus.
This process is just an application of the more general marginal price calculation procedure discussed previously in section \ref{subsec:marginal_price_sketch}.

We consider maximising the sum of utility: $\sum_{i\in B} u_i(p_i)$ subject to the DC powerflow constraints in equations \ref{dcopf1}.
In this context the power conservation constraints on each bus are the constraints $p_j = \sum_{(i,j)\in C}p_{i,j}$, and the lagrange multipliers associated with these constraints are the marginal prices for power on each of the respective busses.

What is most notable about Locational Marginal Pricing, as witnessed here and elsewhere, is that it is computationally easier than other schemes as only one optimisation problem is needed to be solved.
Because of this, there are many optimisation solvers which able to handle these optimisation problems, which also give the Lagrange multipliers of all of the constraints as a byproduct.

The SCIP optimisation suite\footnote{development reported by \cite{MaherFischerGallyetal.2017}} was employed for the optimisation of our example network, and the results of the calculation are shown in Figures \ref{fig:1f} and \ref{fig:1e}.
These figures show the utility transfers under LMP which each participant makes, and the net utility which each participant has after transfers are made under LMP respectively; the discussion and comparrison of these figures is given in section \ref{sec:features}.

\subsection{Computing the VCG imputations}\label{subsec:VCG_compute1}

Unlike LMP, calculating VCG payments for our example network involves solving multiple optimisation problems.
From section \ref{sec:solutions_VCG} we see that the utility payment that each participant makes is their externality, where the externality is the difference that the participant's presence makes on the welfare of other participants.
More specifically, the VCG payment that a participant makes is the difference between the sum of other's utility at the social optimum point $x^*$, and the utility that others would have if the participant were not present and the optimisation were only over the remaining participants, as seen in equation \ref{eq:VCG_payment_rule}.

In this way the socially optimum value $x^*$ needs to be computed, and then additionally an additional optimisation problem for each player - where we assume that the excluded participant has power zero $p_i=0$. Thus in our context, equation \ref{eq:VCG_payment_rule} becomes:
\begin{equation*} d_i(v)=\argmax_{\sum_{j} u_j(p_j)}\sum_{j\ne i}u_j(p_j) - \argmax_{\sum_{j\ne i} u_j(p_j), p_i=0}\sum_{j\ne i}u_j(p_j)\end{equation*}

The first term in this equation is the sum of utilities at the point which maximises the sum of utilities minus the player $i$.
The second term in this equation is the sum of other's utilities (ie. excluding player $i$) at the point which maximises the sum of other's utilities in the context that the players power is zero.
The first part of the equation is common to all player's contributions $d_i$, but the second negative part is unique for each.
In this way, if there are $n$ participants, there are $n+1$ comparable OPF optimisation problems which need to be solved to calculate VCG payments.
The SCIP optimisation suite was used solving these optimisation problems (as similar to section \ref{subsec:LMP_compute1}), and the resulting utility payments, and post-payment utilities under VCG are shown in Figures \ref{fig:1h} and \ref{fig:1g}.
The discussion and comparison of these figures is given in section \ref{sec:features}.


\subsection{Computing the GNK value}\label{subsec:gnk_compute1}

The GNK value is difficult to solve because of the bilevel structure of \eqref{knvalue1} which must be computed for each of the possible coalitions of network participants.
Even though we have modelled our example network with a set of linear utility functions and linear constraints (as given in section \ref{sec:the_setup}), equation \eqref{knvalue1} is still quite difficult to solve as it constitutes a linear bilevel program (LBP) which are a class of problems known by to be NP-hard. \citep{DBLP:journals/tec/SinhaMD18,Ben-Ayed:1990:CDB} 

There exist a range of techniques which can be used to solve LBPs, such as summarised by \cite{DBLP:journals/tec/SinhaMD18,S.Dempe.Optimisations}.
Some of the many methods include: vertex enumeration processes \citep{Bialas:1984:TLP:2784019.2784026,Shi:2005:EKA:2641854.2642183,LIU1995644}; penalty method schemes \citep{KleinertSchmidt2019,ONAL1993126,dempe_optimisation111};
cutting plane approaches \citep{cuttingplane1};
branch-and-bound/cut methods \citep{SHI200551,Hansen:1992:NBR:141164.141181,Audet2007};
and approximating algorithms \citep{Pineda2018,rnnlbp1,genetic_algirthm_blp}.

One well known way of addressing LBPs involves converting the inner optimisation constraints into KKT conditions (introduced by \cite{kuhn1951nonlinear}), and then converting the complementarity conditions into disjunctive constraints with binary variables - see \cite{Fortuny-Amat1981,Pineda2018}.
In this way, a bilevel program is converted into a mixed integer linear program, which is then directly amenable to standard optimisation software.
This method was chosen, and the SCIP Optimisation Suite was employed to compute the GNK value for our example network as described in the previous section \ref{sec:example_network}.

KKT conditions are a well known set of algebraic tests which imply that the function under consideration is locally optimal (maximal or alternatively minimal) with respect to its variables under a set of constraint functions (with some regularity assumptions on thoes functions).
KKT are well documented, and extend the method of Lagrange multipliers.

Specifically for maximising an objective function $f(\mathbf{x})$ subject to multiple constraints:
\begin{equation}\label{eq:KKT_condition1} g_k(\mathbf{x})\le 0 \end{equation}
\begin{equation}\label{eq:KKT_condition2} h_j(\mathbf{x})=0 \end{equation}
Then $\mathbf{x}*$ is a local maximum if the following KKT conditions are true:
\begin{equation}\label{eq:KKT_conditions3} \nabla f(\mathbf{x}*) - \sum_k\lambda_k\nabla g_k(\mathbf{x}*) - \sum_j\mu_k\nabla h_k(\mathbf{x}*) =0\end{equation}
and equations \ref{eq:KKT_condition1} and \ref{eq:KKT_condition2} hold for $\mathbf{x}*$, and for all $i$ that $\lambda_i\ge 0$ and $\lambda_ig_i(\mathbf{x}*)=0$.

By KKT conditions, we can convert the DC powerflow constraints given by equations \ref{dcopf2} into a set of equations for maximising an objective function $f(p_{i\in B})$:

\begin{equation}\forall i~~\frac{\partial f}{\partial p_i}(p_{i\in B})=\sum_j\mu_j\frac{\partial h_j}{\partial p_i}(p_{i\in B}) + \sum_k\lambda_k\frac{\partial g_k}{\partial p_i}(p_{i\in B})\end{equation}
\begin{equation}\forall j~~ h_j(p_{i\in B})=0\end{equation}
\begin{equation}\forall k~~ g_k(p_{i\in B})\le 0\end{equation}
\begin{equation}\forall k~~ \lambda_k \ge 0\end{equation}
\begin{equation}\label{eq:complementarity_constraint_KKT}\forall k~~ \lambda_kg_k(p_{i\in B}) = 0\end{equation}

Hence the reformulation of our LBPs in equation \ref{knvalue1} involves transforming the inner maximisation/minimisation constraints into KKT conditions.
The sets of variable values which satisfy the KKT conditions are called KKT points, if we denote the set of values of an maximised objective function $f(p_{i\in B})$ at the KKT points as $\mathcal{KKT}(f(p_{i\in B}))$.
Then reformulation of the inner part of \eqref{knvalue1} to involve KKT conditions is as follows:




\begin{equation}
\label{kkt_optimization1}
\begin{aligned}
v(S) =& 
 \frac{1}{2}\max_{\substack{p_i \\ i\in S}}   \min\left[-\mathcal{KKT}\left(-\sum_{i\in S} u_i(x,y) + \sum_{i\in N\setminus S}u_i(x,y)\right)\right] +\\
&\frac{1}{2}\min_{\substack{p_i \\ i\notin S}}\max\left[\mathcal{KKT}\left(\sum_{i\in S} u_i(x,y) - \sum_{i\in N\setminus S}u_i(x,y)\right)\right]
\end{aligned}
\end{equation}


By reformulating the inner maximisations/minimisations of \eqref{knvalue1} in this way we replaced the inner minimisations/maximisations in the space $(x,y)\in A$ with minimisations/maximisations over KKT points in the same space.%\footnote{By doing this we tacitly we assume that $u_i(p_i)$ is continuously differentiable, and satisfy some regularity conditions.}

As the constraints under DC-approximation are linear and hence define a convex polygon,
%if we assume that the functions $u_i(p_i)$ are concave then there is either: only ever a single KKT point for all sets of outer variables, or (if weakly-concave) then any of the KKT points will be equal to the global minima (maxima).
%Hence the inner maximization (minimization) over the KKT points can be ignored.
and as the functions $u_i(p_i)$ are linear (per the assumption of linear utility in section \ref{sec:the_setup}), then there will only be a single maximum/minimum value of these inner minimisations/maximisations - which will be the global maximum/minimum value.\footnote{as linear optimisation problem has a unique solution, although there may be multiple points which attain this maximum/minimum value}
In this way the inner maximisation (minimisation) over the KKT points can be ignored.

It was also realised that a binary reformulation of the complementary slackness conditions (equation \ref{eq:complementarity_constraint_KKT}) would increase computational efficiency, and so we transformed these complementarity constraints into disjunnctive binary constraints.

Specifically, for each complementary slackness condition $\lambda_kg_k(p_{i\in B}) = 0$ we introduced a binary variable $Z_k$ to indicate whether $\lambda_k$ or $g_k(p_{i\in B})$ was zero and then introduced large numbers $\bar{\lambda}_k$ and $ \underline{g_k} $ such as to make the complementary slackness condition equivalent to: $(1-Z_k)\bar{\lambda}_k \ge \lambda_k \ge 0$ and $\underline{g_k}Z_k\le g_k(p_{i\in B})\le 0$.
Where $\bar{\lambda}_k$ and $\underline{g_k}$ are the estimated upper and lower bounds on the KKT multipliers and constraint functions respectively.

the resulting KKT conditions for maximising and objective function $f(p_{i\in B})$ under this complementary slcakness conditions are as follows:

\begin{equation}\forall i~~\frac{\partial f}{\partial p_i}(p_{i\in B})=\sum_j\mu_j\frac{\partial h_j}{\partial p_i}(p_{i\in B}) + \sum_k\lambda_k\frac{\partial g_k}{\partial p_i}(p_{i\in B})\end{equation}
\begin{equation}\forall j~~ h_j(p_{i\in B})=0\end{equation}
\begin{equation}\forall k~~ g_k(p_{i\in B})\le 0\end{equation}
\begin{equation}\forall k~~ (1-Z_k)\bar{\lambda}_k \ge \lambda_k \ge 0\end{equation}
\begin{equation}\forall k~~ \underline{g_k}Z_k\le g_k(p_{i\in B}) \le 0\end{equation}

if we denote the set of values of an maximised objective function $f(p_{i\in B})$ that satisfy these new KKT conditions $\mathbb{KKT}(f(p_{i\in B}))$.
Then reformulation of the inner part of \eqref{knvalue1} to involve KKT conditions is as follows:

The resulting reformulation is as follows:

\begin{equation}
\label{optimization_eq1}
\begin{aligned}
v(S) =
&\frac{1}{2}\max_{\substack{p_i \\ i\in S}}   \left[-\mathbb{KKT}\left(-\sum_{i\in S} u_i(x,y) + \sum_{i\in N\setminus S}u_i(x,y)\right)\right] +\\
&\frac{1}{2}\min_{\substack{p_i \\ i\notin S}}\left[\mathbb{KKT}\left(\sum_{i\in S} u_i(x,y) - \sum_{i\in N\setminus S}u_i(x,y)\right)\right]
\end{aligned}
\end{equation}

This reformulation renders the LBP into a mixed integer program which is directly amenable for calculation by optimisation solvers, and the SCIP optimisation suite was used in our case.

Using the SCIP optimisation suite, the GNK transfers we calculated, and in Figures \ref{fig:1d} and \ref{fig:1c} show the utility transfers and the post-transfer utilities under GNK; we discuss these figures next.


\section{Some features of GNK}\label{sec:features}

In this section we discuss the characteristics of the GNK value, against LMP and VCG, for the example 5-bus network (from Figure~\ref{fig:example1}).

For GNK, LMP and VCG, the power allocations and the utilities associated with these power allocations are plotted against $p_1^l$ (the generator capacity in the network) and are shown in Figures \ref{fig:1a} and \ref{fig:1b}.
And through subsequent pairs of figures we can see how the different mechanisms allocate payments and utilities in the context of constrained resources - Figures \ref{fig:1c}, \ref{fig:1d} for GNK, Figures \ref{fig:1e}, \ref{fig:1f} for LMP, Figures \ref{fig:1g}, \ref{fig:1h} for VCG.

\iffigures
% \input{graph0.tex}
\input{figs/GNK_graph1.tex}
\fi

In Figure~\ref{fig:1a}, increasing the generator capacity from $0$ shows that power is initially consumed entirely by the consumer at bus 2, 
who uses all $p_1^l$kW of power and values it at a rate of 1.9 units of utility. This continues until the power constraint on line (1,2) binds, at 70kW.
Then the consumer at bus 3 begins to be supplied with power, who values it at a rate of 1.8 units of utility until its consumption is maximised at 100kW. 
This dynamic is then repeated for the agent with the next-highest marginal utility for power (given by the utility function coefficients in Table~\ref{tab:example1}), until the respective line constraints are also met.

In the interval of the first 70 units of generator capacity (ie. $p_1^l \in [0,-70]$), the LMP price for this power, for both the generator at bus 1 and the consumer at bus 2, is given by its marginal value 1.9 (as the line constraint is not active). This corresponds to the slope of the black line in Figure~\ref{fig:1f} (or \ref{fig:1b}) over this interval. 
More generally, the full set of the LMP transfers plotted in Figure~\ref{fig:1f} are given by the Lagrange multiplier for power conservation in the OPF optimisation multiplied by the power consumed at that bus, and that as the generation capacity increases the marginal price of power changes, and the gradients of the lines change in discrete steps as the utility functions in the example network are linear.

Additionally, the VCG payments are plotted against $p_1^l$ in Figures \ref{fig:1h} and resulting utilities in Figure \ref{fig:1g}.
The VCG payments are similar to the LMP payments, except that instead of payment proportional to the marginal unit of electricity, each player is compensated at his/her marginal cost of their participation.
VCG takes into account the marginal effect that each of the player's participation has apon each other at the social optimum

In contrast VCG and LMP, the GNK value takes into account the full bargaining position of each agent and also every possible coalition of agents when determining transfers, which are based on the utilities (or costs, in the case of the generator) of all agents in the system, and not just the marginal value of participation or electrical supply.
The GNK value is plotted against $p_1^l$ for our example in Figure~\ref{fig:1c}, and the resulting transfers (GNK value less utility) are plotted in Figure~\ref{fig:1d}.

From these graphs we can witness some of the qualities of the GNK value against LMP and VCG.

\subsection{Specific features of the GNK value}

From these graphs we can witness that LMP, VCG and GNK values feature a range of different dynamics,
but some particularly notable qualities of the GNK value include:

% \begin{itemize}
% \item GNK is continuous in the parameters of the network
% \end{itemize}

\subsubsection*{The GNK value and VCG imputations are continuous in the parameters of the network}
The GNK value has some evident continuity properties, as can be seen from equation \ref{knvalue1}, in which the minimax characteristic function, $v(S)$, always changes continuously with the utility functions $u$.
This continuity property is proven in the Appendix \ref{appendix:continuity_of_GNK}, together with some associated monotonicity properties.
%, and are generally continuous with continuous deformations of the strategy space $A$.
This continuity is similarly witnessed in VCG imputations, but notably not in the context of LMP payments.

It is seen that LMP features discontinuous changes in financial transfers and this can clearly be seen from the jagged edges in Figure \ref{fig:1f}, where the payments received by generator 1 drop sharply with increasing generator capacity.
This might be seen to lead to a somewhat perverse incentive to produce less power than what is socially optimal, and in contrast, the utilities under the GNK value (Figure \ref{fig:1c}) and VCG  (Figure \ref{fig:1g}) feature no such drops or discontinuities.
In a power systems context under LMP, these discontinuities are known to occur precisely in the event of network \emph{congestion}
which is one known cause of the volatility experienced in electricity markets - see \cite{RePEc:aen:journl:2006v27-02-a09}. 
In contrast, the post-payment utilities under the GNK value and VCG are almost always continuous with network parameters.


%In the electrical context, 
%$v(S)$ will change continuously when the utilities of the participants and/or the network constraint functions change continuously. 
%In these cases, because $v(S)$ will change continuously, the GNK value $\varphi$ will also change continuously. 

% \begin{itemize}
% \item the GNK value is always budget balanced
% \end{itemize}
\subsubsection*{The GNK payments are always budget balanced}
The transactions under LMP and VCG are not necessarily budget-balanced and can yield a surplus or deficit, whereas payments under the GNK value are necessarily budget-balanced and result in no surplus or deficit.
This is an outcome of the GNK value's axiomatic derivation, as given by equation \eqref{myeq}.
Under LMP, each participant is credited or debited at the effective rate of supply for their location but there is no guarantees that the total payments should add to zero.
This can be seen by inspecting the region $x>300$ in Figure~\ref{fig:1f}, where generator 1 is credited $\$56$ while the consumers are debited at $\$133.0$, $\$160.0$, $\$119.0$, and $\$64.0$ respectively, leading to a budget surplus of $\$420$.
The surplus of $\$420$ comes particularly from the existence of congestion in the example network which is well known to introduce so-called ``congestion-rents'' that are usually collected by owners of transmission lines (and which are often also the owners of the utility-scale generation assets in vertically-integrated systems - see \cite{lmp2}).
Additionally VCG payments are known not to be budget balanced generally and may yield a surplus or deficit depending on various conditions, as considered in section \ref{sec:solutions_VCG}.

%In a power systems context, budget-balancedness of payments is desirable in that any revenue/deficit collected is independent of the network operating conditions.

% \begin{itemize}
% \item the GNK value can offset those that do not receive/generate power
% \end{itemize}
\subsubsection*{The GNK value (but not VCG or LMP) can offset those that do not receive or generate power}
The GNK value can allocate payments between parties such that the consumers that receive power compensate those that are excluded from receiving it.
This can be seen from Figures \ref{fig:1a} and \ref{fig:1c} particularly in the region where $x<50$.
In this region there is only sufficient power to supply consumer 2 (who has the highest utility for that power) whereas consumers 3, 4 and 5 who would otherwise be in a position to receive that power are
compensated such as to be barely worse off (as can be seen from \ref{fig:1c}).

For instance at $x=50$, generator 1 produces $50$kW which is consumed entirely by consumer 2; the utilities of the participants before transfers are: $-10, 95, 0, 0, 0$ respectively (which can be seen from Figure \ref{fig:1b}).
However under the GNK value, consumer 2 must pay both the generator and also the other consumers for its right-of-way to consumption.

The utilities after the transfers of the participants are: $0.5, 23.83, 21.33, 20.08, 19.25$ respectively (which can be seen from Figure \ref{fig:1c}).
In a power systems context, this is likely to be seen as a desirable quality as it may correspond to people's intuitions about the fair allocation of resources.
For example, distribution network feeders that have a high penetration of PV systems have been identified by \cite{feeder1} to experience voltage rise problems at 
times of high-supply/low-demand, particularly at the feeder extremities. 
In these settings, the inverters of PV owners at the bottom are unable to inject their power into the network and also typically get no compensation for essentially a forced curtailment of their electricity generation.

In this context under LMP, curtailed generators that dont inject their power get no reward, and under VCG curtailed generators will only be allocated utility if their presence or absence would make a difference to the network operating point, which is not assured.

% \begin{itemize}
% \item the GNK value is not incentive compatible
% \end{itemize}
\subsubsection*{The GNK value is not incentive compatible}
Unlike VCG, the GNK value and LMP are not \emph{incentive compatible} in the sense that is often referred-to in Mechanism Design (see Section \ref{sec:solutions_VCG}).
Specifically, the payments between parties are potentially subject to strategic manipulation if the agents are freely able to report their utility.
In the GNK value this can be seen in \eqref{knvalue1}, or more easily in its reduced form, \eqref{knvalue2}, where the payoff advantage of a coalition $v(S)$ is based on its reported utilities in minimax strategies which may not be actualised.
And hence, misreporting these utilities may change the $v(S)$ and hence the GNK value itself.
Additionally, LMP is known not to be incentive compatible, and there is further work to understand exactly how consequential this would likely be - such as by \cite{8054716}.
In section \ref{sec:GNK_extensions_discussion} we continue discussion about this point.

% \begin{itemize}
% \item the GNK value is computationally difficult
% \end{itemize}
\subsubsection*{The GNK value is computationally difficult}
The GNK value is more difficult than VCG and significantly more difficult than LMP, to compute.
This can be seen via \eqref{da_value_eq} where calculating the GNK value exactly requires calculating $v(S)$ for all the $2^n-1$ possible coalitions $S$, and each calculation of $v(s)$ is an NP-hard bilevel optimisation problem.
This computational difficulty is reflected in a later Figure \ref{fig:performance_graph2} where it is seen that even using sampling to approximate the GNK value is double-exponentially complex. 
This difficulty contrasts against the ease of computing LMP which requires only solving one OPF optimisation, and VCG which requires $n+1$ OPF optimisations.

In light of this difficulty, we consider different ways of mitigating the issue so that the GNK value can be applied to larger networks.


\section{Scaling the GNK value}\label{sec:scaling}

Because the GNK value is difficult to compute at scale, we review two primary approaches to approximate the GNK value for larger and more realistic networks:

\begin{itemize}
    \item In sections \ref{sec:sampling_techniques} to \ref{subsection:selection_of_sampling_method} we describe and employ sampling techniques to reduce the number of minimax optimisations that need to be conducted to approximate the GNK value to sufficient accuracy.
    \item And in section \ref{sec:modified_gnk} we consider a polynomial-time computable proxy inplace of the minimax optimisations in the characteristic function \eqref{knvalue1} of the GNK value.
\end{itemize}

\subsection{Sampling techniques}\label{sec:sampling_techniques}
To compute the GNK value to a required accuracy, not all of the minimax optimisations $v(S)$ need to be performed, as sampling techniques may be used.
We consider two different approaches for bias free sampling of the GNK value:
\begin{enumerate}
    \item By the inspection of equation \ref{da_value_eq}, we see that the GNK value of any player $i$ is an average over $v_{i,k}$%(the average value $v(S)$ for coalitions $S$ of size $k$ that include player $i$)
, and that by randomly sampling coalitions of size $k$ which include $i$ we can sample for estimations of each $v_{i,k}$.
    \item By utilizing equation \ref{convert1} we convert the problem into a standard cooperative game, where we can then compute the GNK value via the many existing sampling techniques developed for approximating the Shapley Value.
\end{enumerate}

The first of these two is an uncomplicated approach consisting of randomly generating coalitions $S\subset N$, %(implicitly also calculating $v(N\setminus S)$ via equation \ref{myeq2})
and then approximating $v_{i,k}$ by averaging the appropriate $v(S)$, which are then averaged to approximate the GNK value $\varphi$ via equation \ref{da_value_eq}. We denote this method `\textsc{Simple}'.

The second of these two approaches is more complicated, since it involves converting the problem into a cooperative game and then a selecting a technique to sample the Shapley Value.
Some of the possible techniques include: Neyman Sampling (`\textsc{Neyman}') \citep{CASTRO2017180,1938.10503378}, sampling to minimize a Hoeffding-type inequality (`\textsc{Hoeffding}') \citep{2013arXiv1306.4265M}, as well as a random stratified join-order sampling method (`\textsc{Join}') \citep{CASTRO2017180}, and unstratified random join-order sampling `ApproShapley' (`\textsc{Appro}') \citep{DBLP:journals/cor/CastroGT09}.
We consider these alongside our own developed method, the Stratified Finite Empirical Bernstein Sampling method (`SEBM') (as developed in Section \ref{section:SEBB}).

We will compare the performance of these sampling approaches in section \ref{section:performance}, but first we will summarise some of the differences between Shapley Value sampling techniques first.

\subsection{Differences in sampling approaches}

All the Shapley Value sampling technique sample over marginal contributions in slightly different ways; but primarily, they differ in whether they employ stratified sampling or not.
If they employ stratified sampling, then they sample the marginal contributions by player $i$ and size $k$ and average them to estimate each $\hat{v}_{i,k}$ (ie. approximating the terms of \eqref{eq:shapley_value2} and then using \eqref{shap2}).
Conversely, if they do not employ stratified sampling, then they directly approximate the Shapley Value via equation \eqref{shapley_value3}.

Secondarily, they differ in whether or not they sample by a join-order process or not. Sampling over marginal contributions involves calculating the difference between $v(S)$ and $v(S\cup\{i\})$ for various players $i$ and coalitions $S$, and one particularly easy way of doing this is to start with the empty coalition $\emptyset$ and generate a permutation of players that sequentially join the coalition and each make a marginal contribution in turn, in this way $n+1$ evaluations of $v(S)$ can be used to calculate $n$ marginal contributions.
Conversely, if they do not use a join-order process, then the methods randomly select coalitions $S$ and player $i$ and calculate the marginal contribution $v(S\cup\{i\}) - v(S)$, thus taking two evaluations of $v(S)$ for one marginal contribution sample point.

Between the methods, as shown in Table \ref{table:stratified_sampling_methods}: \textsc{Appro} randomly samples in join orders without stratification, \textsc{Join} randomly samples in join orders with stratification, \textsc{Hoeffding} samples with stratification and without join orders, to minimise a sum of Hoeffding-type concentration inequalities on each of the estimates $\hat{v}_{i,k}$,
\textsc{Neyman} samples with stratification without join orders to the sample each $\hat{v}_{i,k}$ proportional to the sample variance of the marginal contributions which make up each,
and \textsc{SEBM} samples with stratification without join orders to sample $\hat{v}_{i,k}$ in order to maximally reduce a complicated concentration inequality on the resultant estimated Shapley Value itself.

\begin{table}[]
\centering
\begin{tabular}{|l|l|l|l|}
\hline
Method & Stratified & Join-Order & Sampling Choice \\ \hline
\textsc{Appro} & No & Yes & Random\\
\textsc{Join} & Yes & Yes & Random\\
\textsc{Hoeffding} & Yes & No & Hoeffding-type inequality \\
\textsc{Neyman} & Yes & No & by variance of the strata \\
\textsc{SEBM} & Yes & No & speciality inequality\\ \hline
\end{tabular}
\caption{Different Shapley Value sampling methods and their features}
\label{table:stratified_sampling_methods}
\end{table}

The full details about each of the methods can be found in their respective source documents \citep{CASTRO2017180,2013arXiv1306.4265M,DBLP:journals/cor/CastroGT09} (and Chapter \ref{chap:stratified_sampling_chapter}).
And the performance of using these different methods is evaluated in the next section \ref{section:performance}.

\subsection{Sampling the GNK value at scale}\label{section:performance}

To analyse the performance of approximating the GNK with different sampling techniques we calculated the average absolute error in the approximated GNK value for randomly generated electricity networks.
We used a known process of generating pseudo random meshed networks of buses and lines reminiscent of real electricity networks. The particular algorithm is called the `Simple minimum-distance graph' method as expounded by \cite{hines1} and is given as Algorithm \ref{alg1}.

\begin{algorithm}[]
\caption{Simple minimum-distance graph algorithm}
\label{alg1}
\begin{algorithmic}
    \REQUIRE number of nodes $N$, number of links $m$
    \REQUIRE natural numbers $n_i$, such that $\forall~i~n_i\leq i$ and also $\sum_{i=1}^Nn_i=m$
    \STATE $M=\emptyset$ is set of nodes
    \FOR{$a=1:N$}
        \STATE Randomly generate planar coordinates for node index $a$, $(x_a ,y_a)$ with uniform distribution
        \STATE $M_a=\emptyset$ is set of links for node index $a$
        \FOR{$k=1:n_a$}
            \STATE select a novel $b\in M$ to minimise the Euclidean distance to node index $a$:\\ $\quad\min_b\quad (x_a-x_b)^2+(y_a-y_b)^2\quad\text{s.t}\quad (a, b)\notin M_a$
            \STATE Add the link $a$-to-$b$:\\ $\quad M_a=M_a\cup \{(a, b)\}$\\ $\quad M_b=M_b\cup \{(b, a)\}$
        \ENDFOR
        \STATE Add the node $a$:\\ $\quad M=M\cup \{(x_a ,y_a)\}$, 
    \ENDFOR
    \STATE Output $M$ and $M_a$ 
\end{algorithmic}
\end{algorithm}

Using this algorithm we considered networks which were randomly generated to have 10 nodes with 12 lines between them, and thus small enough for it to be possible to solve the GNK value exactly.
And in each of these networks each line had randomly generated line limits and each node was assigned to be either a generator or consumer of electricity randomly with a randomly generated linear utility function with randomly generated consumption/generation limits.

By computing the exact GNK value for these networks we were then able to compute the average absolute error achieved by each of the different sampling methods for different sample budgets.
For a given budget, all the algorithms called for the computation of different numbers of the bilevel optimisations $v(S)$ (per equation \ref{knvalue1}).
And by plotting the average absolute error achieved against the number of unique optimisations called, we can see the performance of the sampling methods as shown in Figure \ref{fig:performance_graph1}.

From this graph it is seen that the methods which utilised stratification (\textsc{Hoeffding}, \textsc{Neyman}, \textsc{SEBM} and \textsc{Join})  generally performed better than those that did not use stratification (particularly \textsc{Simple} and \textsc{Appro}).
And particularly that the \textsc{Join} method, which utilises stratification and join-order sampling is quite effective over a range of situations.

On this graph, the sampling methods which utilised stratification were warm-started with a budget of 200 samples (two from each strata), as methods like \textsc{Neyman} required atleast two samples per stratum minimum (totalling 200) for a bias-free estimate of the variances which they run on.
Conversely \textsc{Simple} and \textsc{Appro} were able to be run with a smaller sample budget.
It is noted that the methods \textsc{Hoeffding}, \textsc{Neyman}, \textsc{SEBM} and \textsc{Join} perform exactly the same at 200 samples, as they each have two samples per stratum and no extra budget for any difference in logic to operate on.
It was also recognised that because of our 10 bus networks, there are only 1024 unique optimsations $v(S)$ that can be called, and hence the x-axis stops at 1024.
Each of the methods were run multiple times with increasing sample budget allowances, up until a point where the computation time became prohibitive, particularly some of the methods which used sampling without replacement would only call a stochastic number of unique optimisations, and hence it became time-prohibitive to sample to perfect accuracy utilising them.

\subsection{Selection of sampling method}\label{subsection:selection_of_sampling_method}

From the Figure \ref{fig:performance_graph1} we witnessed that \textsc{Join} was seen to be reasonably effective and it was chosen for all further analysis.
The reason for this superiority is the additional power of sampling with stratification and by join-orders.
As already stated, by using join orders, it is possible to calculate $n$ marginal contributions using $n+1$ evaluations of $v(S)$ as opposed to taking two evaluations of $v(S)$ for one marginal contribution sample point.
This simple factor outweighed the advantage of the extra sophistication associated with \textsc{SEBM} and \textsc{Neyman} methods, which did not use join-order sampling - even though SEBM was seen to be more performant for larger sample budgets.
Another advantage that was witnessed in utilising the \textsc{Join} method was that it didn't have the computational overhead of using the formulas present in the \textsc{SEBM} method, and additionally the join-order sampling allowed each new optimisation that was called to be warm-started by the previous one as each new addition to the coalition would yield an optimisation similar to the previous one.
These factors made \textsc{Join} appear as simpler and more effective method for our purposes.

To evaluate the performance of the \textsc{Join} method in approximating the GNK value for larger networks, we generated random networks of different sizes and estimated the GNK value using 8 simultaneous estimations, and timed how long it took for the average magnitude of error between these estimations to reach an one percent of each other.
A scatter plot of the run-time performance of \textsc{Join} in approximating the GNK value for variously sized random networks by this process was generated and the results are shown in Figure \ref{fig:performance_graph2}.

From this figure it is witnessed that the GNK value appears to be doubly exponentially complex to approximate by sampling and quickly becomes intractable for networks consisting of more than $16$ busses.
This double-exponential complexity was somewhat expected as solving the GNK value exactly is identified as a calculation that involves exponentially many NP-hard computations.

In light of this realisation we sought to make simplifications to the GNK value itself to ease its intractability.
Specifically we considered a polynomial-time computable proxy inplace of the minimax optimisations in the characteristic function \eqref{knvalue1} of the GNK value.

\iffigures
\input{figs/absolute_error1.tex}
\fi

\iffigures
\input{figs/approximating_times1.tex}
\fi



\subsection{Sampling a modified GNK value (M-GNK) at scale}\label{sec:modified_gnk}

Given the intractable nature of the GNK value for large networks, we considered a proxy inplace of the minimax optimisations of the characteristic function that define the GNK value (equation \ref{knvalue1}).
Particularly we considered a relaxation:

\begin{align}
\label{knvalue22}
v(S) = &+ \frac{1}{2}\left(\sum_{i\in S} u_i(p_i) - \sum_{i\in N\setminus S}u_i(p_i)\right)\nonumber\\
&\quad\quad\quad\quad\quad~\text{s.t}~ \left[\{p_i\}_{i\in N}=\argmax \left(\sum_{i\in S} u_i(p_i) + \sum_{i\in N\setminus S}\epsilon u_i(p_i)\right)\right]\nonumber\\
&- \frac{1}{2}\left(\sum_{i\in N\setminus S}u_i(p_i) - \sum_{i\in S} u_i(p_i)\right)\nonumber\\
&\quad\quad\quad\quad\quad~\text{s.t}~ \left[\{p_i\}_{i\in N}=\argmax \left(\sum_{i\in N\setminus S}u_i(p_i) + \sum_{i\in S} \epsilon u_i(p_i) \right)\right]
\end{align}

Where $\epsilon$ is a small positive value, and where we assume all the DC power constraints apply in both $\argmax$.

Rather than equation \eqref{knvalue1}, this equation \eqref{knvalue22} encapsulates the expected payoff advantage of the coalition under a 50:50 coinflip of who goes first, where in each case the leader chooses the powerflows that strictly prioritise their own utility and then the follower's utility is maximised secondarily, we call this proxy GNK value the `M-GNK value'.\footnote{This dynamic is evident for sufficiently small $\epsilon$ in the formula, but the same dynamic could also be achieved by a two stage optimisation process.}
This expression encodes much of the same dynamic as the original expression (equation \ref{knvalue1}) but avoids much of the adversarial strategic counter-considerations that make the original expression NP-hard, as the leader is unwilling to sacrifice their utility to harm the follower's utility and vice versa.

This proxy replaces the two-part NP-hard bilevel problems of equation \ref{knvalue1}, into two-part single-level linear programming problems.
This transformation makes the M-GNK value much easier to compute at scale, but potentially at the cost of being a less perfect description of idealised minimax bargaining - even though no axioms (from section \ref{the_value_def}) would be lost.
Thus the use of this proxy might potentially see the introduction of artefacts - we discuss the similarity and the resulting numerical differences between the original GNK and M-GNK in section \ref{sec:GNK_extensions_discussion}.

Some of the runtime statistics of sampling this M-GNK value with \textsc{Join} sampling for randomly generated network sizes are shown in Figure \ref{fig:performance_graph4}.
From the figure it is seen that it is readily possible to calculate to about one percent accuracy this M-GNK value in three minutes of runtime for networks of up to the size of about 50 nodes, and with ten minutes of runtime up to about 80 nodes.\footnote{\label{note1} All calculations were performed on an Dell Optiplex 9020, with Intel i7 quad core 3.6GHz processor, and all source-code available at:\\
\href{https://github.com/Markopolo141/The\_Generalized\_N-K\_Value}{github.com/Markopolo141/The\_Generalized\_N-K\_Value}}

Using this ability to calculate, we can now turn our attention to what this M-GNK value actually looks like in comparison with LMP and VCG for larger networks.

%\iffigures
\input{figs/accuracy_graph1.tex}
%\fi



\section{Results and evaluation of the GNK value at scale}\label{sec:results_and_evaluation_of_GNK}

%\iffigures
\input{figs/experiment_table1.tex}
%\fi

In this section we display and discuss some of the behaviour exhibited by the M-GNK, VCG and LMP for randomly generated larger networks.
Particularly in figures \ref{fig:experiment_table_11}-\ref{fig:experiment_table_14} we show the results of these techniques applied to an example 90 bus network (generated by algorithm \ref{alg1}), consisting of a 50-50 split of small consumers and small generators of electricity.
From this exercise we are able to see some of the distinct features of these techniques when applied to a large number of players.

The most immediate result is that LMP and VCG are nearly identical (figures \ref{fig:experiment_table_11} and \ref{fig:experiment_table_12}) while GNK is distinctly different (\ref{fig:experiment_table_13}).
The similarity between VCG and LMP can be explained by a variety of means.
But a most informal explanation is that both LMP and VCG implement the same electrical outcome, and allocate payments in proportional to marginal differences about the socially optimal point.
The confluence between VCG and LMP is not only witnessed by us, but also has been noted in a more general settings where there are many small participants \citep{NATH2019673, 8430852} (see section \ref{subsec:summary_discussion_VCG}).%\ref{subsec:summary_discussion_VCG}

In figure \ref{fig:experiment_table_11} and \ref{fig:experiment_table_12} we see that there are no negative utility imputations, but that positive utility is allocated to those generators who are able to provide power the cheapest, and those consumers who value power the greatest (high x-value \& low y-value, and low x-value \& high y-value respectively).
This is because the LMP creates prices for power such that the cheapest generators are scheduled to create power which is consumed by the most desiring consumers up until a marginal point where any further dispatch/consumption would be unmotivated.
And because VCG schemes allocate non-negative utilities by their axiomatic construction (per axiom of individual rationality).
From these graphs we straightforwardly identify those consumers/generators which generate/receive power as they are rewarded with positive utility.

Conversely we notice in figure \ref{fig:experiment_table_13} a completely different result for the M-GNK value, particularly that the M-GNK imputes utility to those consumers who do not receive power (as already noted in section \ref{sec:features}), but furthermore, it allocates negative net utility to all but the cheapest generators, even those who generate power at the socially optimal point (as identified by the previous paragraph as those generators who have positive imputation under LMP, in figure \ref{fig:experiment_table_11}), and this dynamic is not particularly easy to explain.

One primary explanation, lies in considering the average additional playoff advantage to a coalition of a high-cost generator.
Particularly, if we consider the taking of a 50-50 coin flip about whether the coalition or its complement chooses their strategies first, and if the coalition goes first, then the generator will be idle (bringing no benefit to the coalition), whereas if the complement goes first, then it potentially will get dispatched (hence causing a loss to the coalition) because the complement will choose to consume power and power-constraints must be obeyed, giving them a greater pay off advantage.
Hence the high-cost generator only brings negative payoff-advantage which is reflected in the M-GNK value.

Or more succinctly, the way in which the generators get allocated negative utility is that they are targets of being forced to generate at their own deficit since power-conservation constraints must be obeyed, and this dynamic becomes a negotiating lever, in the selection of threat points.
This consideration works reversely for consumers, who can only consume at a positive utility to them, thus they are at a bargaining advantage which is then reflected in the positive utility they are rewarded with under M-GNK.

This behaviour in the context of large networks was somewhat unexpected; and we summarise the consequences in the following section \ref{sec:GNK_value_discussion}.

\subsection{Possible extensions}\label{sec:GNK_extensions_discussion}

One primary question is how much the behaviour exhibited in figure \ref{fig:experiment_table_13} is entirely the result of us using a modified characteristic function, per the M-GNK value (equation \ref{knvalue22}), over the more original characteristic function of the GNK value (equation \ref{knvalue1}).
In order to investigate this question, the error of using this modification across randomly generated networks was calculated and shown in Figure \ref{fig:performance_graph5}.
This graph shows the cumulative probability of the difference in payments between the GNK and M-GNK - and shows for instance, that 60\% of participants could expect to receive within 10\% what they would have between GNK and M-GNK values, and that this similarity increases for larger network sizes.

From this graph it is noticed that the GNK and M-GNK values feature similarity which seems to increase with the size of the network under consideration --- although for computational reasons, it is increasingly difficult to confirm for networks with a size greater than 13.
This limited observation coincides with expectations that the possible strategic counter-considerations that are discarded by using equation \ref{knvalue22} over equation \ref{knvalue1} become less relevant in the context of larger networks.

Another observation, is that while the GNK remains soluble for networks of less than 13 nodes and the M-GNK value remains soluble for up to 80 node networks (to about 1\% accuracy, as per figure \ref{fig:performance_graph4}), however these numbers might still be regarded as being too small for real-world electrical network modelling.
Larger networks are expected to be tractable for the M-GNK value with more computing power and/or execution time, however further methodological improvements may be necessary to make the GNK value (or anything similar to it) capable of bearing on larger and real world networks.
Some possible avenues of investigation include employing further approximations such as player clustering (such as implemented by \cite{DBLP:journals/corr/abs-1903-10965}), or transforming the problem into a non-atomic form, similar to non-atomic Shapley Value.
However, these technical considerations are secondary to the ethical considerations about the desirability of GNK-type solutions, which we consider in the following section \ref{sec:GNK_value_discussion}.

Another outstanding question, is what the likely outcome would be, under GNK, in the context of strategising network participants.
So, while VCG has some explicit consideration of the strategising of individual agents, and LMP is identified to be largely identical to it in the context of large numbers of small players, the consequences of agents strategising under GNK is not considered here.
As the GNK is incentive incompatible and also quite complex, this issue constitutes both a major consideration and a difficult question.
While there does exist some work on similar (but more complex) solution concepts like GNK that are incentive compatible (such as presented by \cite{myerson1,Salamanca2019}) their investigation and evaluation in the context of electricity networks remain a topic for further investigation.


%\iffigures
\input{figs/probability_comparrison1.tex}
%\fi

\section{Discussion and conclusion}\label{sec:GNK_value_discussion}

To consider the social and ethical value of the GNK value we must loop back to consider some of the topics explored in Chapter \ref{cha:background}.
Particularly we briefly considered some moral elements about the distribution of resources, including Equality, Efficiency, and the various normative reference points which may be pertinent.
We will consider the GNK in light of each of these in turn.

\subsection{Efficiency}
It is easy to realise that the GNK value is axiomatically efficient, specifically in terms of maximising the sum of utility, by axiom (equation \ref{myeq}); and as it is efficient in this regard it is also therefore Pareto optimal.
The way this efficiency is implemented is that the GNK designates the electrical outcome which maximises the sum of utility, and issues budget-balanced utility transfers between the players.
Neither LMP or VCG has a similar efficiency claim, as both allocate payments between network participants are not necessarily budget balanced.
However in order to consider whether this axiomatic efficiency is actually a good thing we need to consider it in terms of what is socially good.

While there are different and potentially competing philosophical notions of what social 'efficiency' should mean, the maximisation of the sum of utility is a very classical notion.
The implementation of the GNK value assumes that utility is transferable, and the easiest way of comprehending this is in terms of utility as measured by money. And hence, in this context the maximisation of utility might be seen as corresponding to the maximisation of the monetary value of outcomes.

However it is worth noting that this might not be socially desirable, as there may be some sense in thinking that maximising utility via monetary measurement could potentially be prone to social problems, specifically as there exists some agreement of the diminishing value for money itself, in that the rich are made only a little better off by an amount of money, that would be more appreciated by the poor.

The GNK value allocates the utilitarian outcome, however it is not necessarily required that utility be measured in money (even though this is the easiest interpretation).
It is also possible to note that there exist non-transferable-utility (NTU) modifications - such as also considered by \cite{value1} - which could be modified to yield a NTU GNK value.
Such solution concepts could be utilised where utility is not directly transferable and which could incorporate non-linear utilities over possible monetary transactions, potentially resulting in more egalitarian outcomes.

The potential for modifying the GNK value for application in NTU settings in order to account for different efficiency measures is a topic of potential future investigation.

\subsection{Formal-equality}

All the techniques considered (GNK, VCG and LMP, etc.) satisfy formal-equality, as they only treat different participants differently in relation to specific morally relevant characteristics --- particularly their utility preferences, and how their presence and actions can affect the utility of others.
In the electricity context, this involves the utility of electricity and capacity to deliver/generate electricity at their location in relation to the utility of that electricity for others.

However, whether-or-not these qualify as morally warranted bases for differential treatment is the subject of a wider discussion, particularly as differential treatment gives rise to differential incentives.
For instance, the idea of people being afforded different effective prices for electricity depending on the location of their electrical influence may be regarded as being ethically unfair to some people (especially perhaps between close neighbours whose grid connections are electrically different), however a negation of this also destroy any incentive for people to install additional generation capacity in electrically advantageous locations.

Differential treatment can be seen as the mirror image of differential incentives, and a comprehensive reflection of the incentives that would be given under LMP against VCG and GNK are beyond the scope of our consideration.
However we can speculate that there exists a primary difference between VCG and LMP (which give similar results) and GNK, in that LMP and VCG incentivse behaviour that could affect the network operating point; particularly affecting only those generators/consumers which would (or do) generate or consume power at the network operating point.
Wherease GNK is more comprehensive in its consideration, as it affords utility for every possible way that the network could degenerate into adversarial competition; thus we might speculate that the GNK value (or something similar to it) might incentives robustness in the network.

\subsection{Hetrogeny of normative points}

The essential feature of the GNK value is that it is an extension of bargaining solution concepts to multiple players over the restricted strategy space of a generalised non-cooperative games.
%And it inherits the underlying idea that the disagreement point in the non-cooperative game between two parties is the normative reference point from which the cooperative bargaining result is determined.
The GNK value inherits the assumption from Nash bargaining that the minimax of the zero-sum game is the point which is/should-be the disagreement point between any two coalitions for the system, and that all coalitions are equally weighted - however this construction can be questioned.

Firstly, the GNK can be seen to assign equal weight for every possible coalition that could form, irrespective of the likelihood that such coalitions would actually form in competition.
It may be possible to construct a weighted GNK value to account for differential likelihoods of different coalitions forming, but that is a remaining further consideration.

Secondly, the minimax of the zero-sum game identifies a point of maximum strategising to gain payoff advantage specifically over the opponent, irrespective of the absolute payoff to the player.
And in this way minimax of the zero-sum game identifies a point of maximally engaged competition between the players.
%the GNK value integrates this dynamic to consider the space of all possible coalitions and anti-coalitions which could form, and amalgamates all possible minimax's between them into a point of value for each participant in those formations.
Against this consideration, it is good to note, that while the GNK (and Nash bargaining solution concepts) can be viewed as a description of perfect competition between individuals, it can also directly account for the possibility that that groups (or subgroups) of players may be altruistic; in that altruism may be accounted for by a player's utility function including terms associated with positive utility for others.

However this might not be sufficient, and the GNK value contrasts against other similar solutions over non-cooperative games (as briefly mentioned in section \ref{relating_to_the_old}) such von Neumann and Morgenstern's solution (per equation \ref{knvalue3}), where the characteristic function is identified as minimax payoff, not minimax payoff advantage.
In this way von Neumann and Morgenstern's characteristic function can be considered as descriptive of a point of less totally engaged competition between coalitions - which might be more appropriate or pertinent for electricity networks.
Von Neumann and Morgenstern's characteristic function is not the only alternative way that the characteristic function could be constructed, but unfortunately these alternative constructions would not nessisarily yield Nash bargaining solution in the two player case.



%And the question outstanding is, should resources be distributed above the point of such a specific description of perfect competition?

%From this perspective the GNK contrasts against other solutions (such as LMP and VCG) in regards to the reference point which they build upon.
%The VCG solution builds upon the idea that the value of a player should be in reference to their 'absence' only at the solution point of the grand coalition, and therefore cannot allocate resources to thoes who do not interact with such a solution point; and a similar dynamic is present in LMP, in terms of marginal interaction.

%Between the various solutions (LMP, VCG, GNK and possible variants thereof) there are different choices of reference point from which the dynamic occurs, and the question which is pertinent, realistic and morally justified is still ultimately unaddressed.
%However, one particularly important reference point, which is axiomatic to VCG is the reference point of the utility of zero.
%Under VCG the axiom of individual rationality casts the dynamics such that each participant will be rewarded with a non-negative utility.
%If a zero utility is associated with not participating in the system, then individual rationality guarantees that it is better that any participant participates in the mechanism than not.
%This is an important reference point is not manifest in GNK and we discuss it in the next.

\subsection{Wider equality}\label{sec:wider_equality_gnk}

In the development of this research it was hoped that the GNK value would ultimately be witnessed to have a similar individual rationality property as VCG.
Particularly that no participant should be allocated less than zero utility, which might be interpreted as being what they would get if they did not participate in the mechanism.
The ethical importance of individual rationality cannot easily be overstated, particularly as a primary notion of ethical exchange is the concept of `euvoluntary' exchange (see section \ref{sec:reference_points}) which is (at least) where every party is not left worse-off for participating.

However, it is evident that GNK seems to violate this property, as it is possible for participants to be allocated with less less utility than zero.
We would expect that this particular absence of a guarantee for participants would be a major hindrance to GNK's application in electricity systems; hence an ethical failing.
%Indeed, is difficult to imagine how a system which would leave participants worse off than if they did not participate could be good for the wellbeing of society.

In the designing of the GNK value it was hoped that individual rationality would be a property which would be present for larger networks, particularly as it was suspected in section \ref{subsec:nash_bargaining_endogenous} that if it was possible for players to unilaterally implement an outcome which guaranteed them a utility of zero, then they would be guaranteed a non-negative net utility.
However in our GNK application to electricity networks, the enforcement of the power conservation constraints (per equation \ref{dcopf1}) seems to have disallowed this eventuality.

For instance, under GNK value in the context of our generalised game modelling DC networks, the power conservation constraint causes the incorporation of unrealistic bargaining manoeuvres, such as participants extortionately threatening to oversupply others.
It is very possible that alterations to the GNK value, and similar types of Shapley Value structures over non-cooperative game solutions could be made to amend this issue.

It may be possible, for instance, to reconsider the electrical interaction between participants, perhaps by allowing player's action space to be selection of voltage level at their location, rather than directly their power input/output; however in this context power line limits would be manifest as non-linear constraints on the optimisation problem, subsequently making computation more difficult.
It might also be possible to implement blackout costs to participants to curtail the possibility of unrealistic bargaining manoeuvres in the GNK value logic.

In these cases, it might be possible to give participants actions to guarantee themself a disagreement point which affords them a zero utility, and hence restore individual rationality to the resultant GNK value; however these investigations are a topic for future research.

%However ultimately its formulation encodes a specific type of extortionate principle which makes it ethically untenuous.

At a broader level of consideration, it is interesting how perfect competition may or may not coincide with what is equal and ethical.
The question of when and where these coincide, and particularly if they might coincide in the context of electricity networks, was part of the motivation of this research.
Unfortunately our investigations demonstrated that the most direct application of the GNK value would be expected to fail wider social equality considerations.

In the next chapter we delve into the details of the sampling techniques that were developed and tested throughout this research, and we provide a final conclusion to our research in Chapter \ref{cha:conc}. 





